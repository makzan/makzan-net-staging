<!DOCTYPE html>
<html lang="en-US"> 
	<head>
		<meta charset="utf-8" />
		
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		
		<link rel="alternate" type="application/rss+xml" title="Makzan" href="/feed/atom/">
		
		<title>Cron build makzan.net (revised) &#8211; Makzan</title>
<link rel='stylesheet' id='wp-block-library-css'  href='/wp-includes/css/dist/block-library/style.min.css?ver=5.3' type='text/css' media='all' />
<link rel='stylesheet' id='fonts-style-css'  href='//fonts.googleapis.com/css?family=Lato:400,400italic,900' type='text/css' media='all' />
<link rel='stylesheet' id='main-style-css'  href='/wp-content/themes/ponder/style.css' type='text/css' media='all' />
<link rel='stylesheet' id='jetpack_css-css'  href='/wp-content/plugins/jetpack/css/jetpack.css?ver=7.3.2' type='text/css' media='all' />
<script type='text/javascript' src='/wp-includes/js/jquery/jquery.js?ver=1.12.4-wp'></script>
<script type='text/javascript' src='/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<link rel='https://api.w.org/' href='/wp-json/' />
<link rel='prev' title='Props in getInitialState Is an Anti-Pattern' href='/2015/10/props-in-getinitialstate-is-an-anti-pattern/' />
<link rel='next' title='Wave form of iOS voice memos app' href='/2015/10/wave-form-of-ios-voice-memos-app/' />
<link rel="canonical" href="/2015/10/cron-build-makzan-net-revised/" />
<link rel='shortlink' href='https://wp.me/p6ZUtL-38' />
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=https%3A%2F%2F%2F2015%2F10%2Fcron-build-makzan-net-revised%2F" />
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=https%3A%2F%2F%2F2015%2F10%2Fcron-build-makzan-net-revised%2F&#038;format=xml" />

<link rel='dns-prefetch' href='//v0.wordpress.com'/>
<link rel='dns-prefetch' href='//jetpack.wordpress.com'/>
<link rel='dns-prefetch' href='//s0.wp.com'/>
<link rel='dns-prefetch' href='//s1.wp.com'/>
<link rel='dns-prefetch' href='//s2.wp.com'/>
<link rel='dns-prefetch' href='//public-api.wordpress.com'/>
<link rel='dns-prefetch' href='//0.gravatar.com'/>
<link rel='dns-prefetch' href='//1.gravatar.com'/>
<link rel='dns-prefetch' href='//2.gravatar.com'/>
<style type='text/css'>img#wpstats{display:none}</style>
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="Cron build makzan.net (revised)" />
<meta property="og:url" content="/2015/10/cron-build-makzan-net-revised/" />
<meta property="og:description" content="When I setup this blog with periodically building and deploying, I used a local cron. Now I changed to use WebTask and CodeShip to automatically generate the static site and deploy on Surge. I chan…" />
<meta property="article:published_time" content="2015-10-03T09:08:35+00:00" />
<meta property="article:modified_time" content="2015-11-30T09:08:55+00:00" />
<meta property="og:site_name" content="Makzan" />
<meta property="og:image" content="/wp-content/uploads/2015/12/cropped-mz-logo-1.png" />
<meta property="og:image:width" content="512" />
<meta property="og:image:height" content="512" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:site" content="@makzan" />
<meta name="twitter:text:title" content="Cron build makzan.net (revised)" />
<meta name="twitter:image" content="/wp-content/uploads/2015/12/cropped-mz-logo-1-270x270.png" />
<meta name="twitter:card" content="summary" />

<!-- End Jetpack Open Graph Tags -->
<link rel="icon" href="/wp-content/uploads/2015/12/cropped-mz-logo-1-32x32.png" sizes="32x32" />
<link rel="icon" href="/wp-content/uploads/2015/12/cropped-mz-logo-1-192x192.png" sizes="192x192" />
<link rel="apple-touch-icon-precomposed" href="/wp-content/uploads/2015/12/cropped-mz-logo-1-180x180.png" />
<meta name="msapplication-TileImage" content="/wp-content/uploads/2015/12/cropped-mz-logo-1-270x270.png" />
			<link rel="stylesheet" type="text/css" id="wp-custom-css" href="/?custom-css=264d7f9d5e" />
		
		<!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(["setCookieDomain", "*.makzan.blog"]);
  _paq.push(["setDomains", ["*.makzan.blog"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.makzan.blog/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '2']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//analytics.makzan.blog/matomo.php?idsite=2&amp;rec=1" style="border:0;" alt="" /></p></noscript>
<!-- End Matomo Code -->
		
		
	</head>
	
	
	
	
	<body class="post-template-default single single-post postid-194 single-format-standard"><div class="wrap">

			<section>
				<header>
					<h3><a href="/" rel="home">Makzan</a> <span>/ I share what I learnt</span></h3>

			</header>
		</section>

	
	
	
	
	


					<section>
				<article id="post-194" class="post-194 post type-post status-publish format-standard hentry category-web-design">

					<h1 class="post-title">Cron build makzan.net (revised)</h1>
					<p>When I setup this blog with <a href="http://www.makzan.net/2015/09/19/periodically-deploying-middleman-static-site/">periodically building and deploying</a>, I used a local cron. Now I changed to use <a href="https://webtask.io/">WebTask</a> and <a href="https://codeship.com/">CodeShip</a> to automatically generate the static site and deploy on <a href="https://surge.sh/">Surge</a>.</p>
<p><img src="http://www.makzan.net/images/logs/webtask-codeship-surge.png" alt="webtask, middleman, surge" /></p>
<p>I changed the hosting service from <a href="https://pages.github.com/">Github pages</a> to <a href="https://surge.sh/">Surge.sh</a>. Then I followed the <a href="https://surge.sh/help/integrating-with-codeship">Integrating with Codeship</a> tutorial to setup the deployment. I made changes to make it build the middleman site as well.</p>
<p>Here is my <code>package.json</code> file:</p>
<div class="highlight json">
<table>
<tbody>
<tr>
<td class="gutter gl">
<pre class="lineno">1
2
3
4
5
6
7
8</pre>
</td>
<td class="code">
<pre><span class="p">{</span>
  <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"makzan.net-weblog-build"</span><span class="p">,</span>
  <span class="nt">"version"</span><span class="p">:</span> <span class="s2">"1.0.0"</span><span class="p">,</span>
  <span class="nt">"description"</span><span class="p">:</span> <span class="s2">"Makzan.net Weblog Build"</span><span class="p">,</span>
  <span class="nt">"devDependencies"</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">"surge"</span><span class="p">:</span> <span class="s2">"^0.15.0"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre>
</td>
</tr>
</tbody>
</table>
</div>
<p>Here is the <em>Setup Command</em>:</p>
<div class="highlight shell">
<table>
<tbody>
<tr>
<td class="gutter gl">
<pre class="lineno">1
2
3
4
5
6
7
8</pre>
</td>
<td class="code">
<pre>rvm use 2.2.0 --install
bundle install
<span class="c"># Install the latest version of Node.js</span>
nvm install stable
nvm use stable
<span class="c"># Install Surge as a devDependency</span>
npm install
bundle <span class="nb">exec </span>middleman build
</pre>
</td>
</tr>
</tbody>
</table>
</div>
<p>And the <em>Deployment Script</em>, which is a custom one:</p>
<div class="highlight plaintext">
<table>
<tbody>
<tr>
<td class="gutter gl">
<pre class="lineno">1</pre>
</td>
<td class="code">
<pre>surge ./build www.makzan.net
</pre>
</td>
</tr>
</tbody>
</table>
</div>
<p>Now the Codeship builds the middleman site and push to Surge.sh whenever I push the middleman source to the Git repo, which I host it on BitBucket.</p>
<p>For periodically building and deployment. I need to trigger the Codeship building process. I use WebTask for this task. It allows me to schedule a cron on their Backend-as-a-Service, which runs Node.js that I can call the Codeship building API.</p>
<p>Here is the JavaScript file that I install on the WebTask service.</p>
<p><code>codeship-build-makzan-net.js</code> file:</p>
<div class="highlight javascript">
<table>
<tbody>
<tr>
<td class="gutter gl">
<pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre>
</td>
<td class="code">
<pre><span class="c1">// Assume secret for CODESHIP_API_KEY.</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'https'</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">projectId</span> <span class="o">=</span> <span class="s2">"&lt;Your Project ID&gt;"</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">apiKey</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">CODESHIP_API_KEY</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">projectsUrl</span> <span class="o">=</span> <span class="s2">"https://codeship.com/api/v1/projects/"</span> <span class="o">+</span> <span class="nx">projectId</span> <span class="o">+</span> <span class="s2">".json?api_key="</span> <span class="o">+</span> <span class="nx">apiKey</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
  <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">projectsUrl</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"end"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">projectData</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">lastBuildId</span> <span class="o">=</span> <span class="nx">projectData</span><span class="p">[</span><span class="s2">"builds"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">"id"</span><span class="p">];</span>

      <span class="c1">// callback(null, {result:lastBuildId});</span>

      <span class="kd">var</span> <span class="nx">buildUrl</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">hostname</span><span class="p">:</span> <span class="s1">'codeship.com'</span><span class="p">,</span>
        <span class="na">path</span><span class="p">:</span> <span class="s2">"/api/v1/builds/"</span> <span class="o">+</span> <span class="nx">lastBuildId</span> <span class="o">+</span> <span class="s2">"/restart.json?api_key="</span> <span class="o">+</span> <span class="nx">apiKey</span><span class="p">,</span>
        <span class="na">port</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span>
        <span class="na">method</span><span class="p">:</span> <span class="s1">'POST'</span>
      <span class="p">};</span>

      <span class="kd">var</span> <span class="nx">postResult</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
      <span class="nx">http</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">buildUrl</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"end"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="na">result</span><span class="p">:</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">postResult</span><span class="p">)});</span>
        <span class="p">});</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"data"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">postResult</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">}).</span><span class="nx">end</span><span class="p">();</span>

    <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"data"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre>
</td>
</tr>
</tbody>
</table>
</div>
<p>Here is the <code>wt</code> WebTask command that schedules the above JavaScript to run every hour. In addition, I can pass in the Codeship API key into the script file so I don’t need to store the key in plain text.</p>
<div class="highlight shell">
<table>
<tbody>
<tr>
<td class="gutter gl">
<pre class="lineno">1</pre>
</td>
<td class="code">
<pre>wt cron schedule -n codeship-build-makzan-net --secret <span class="nv">CODESHIP_API_KEY</span><span class="o">=</span>&lt;PUT_API_KEY_HERE&gt; <span class="s2">"0 * * * *"</span> codeship-build-makzan-net.js
</pre>
</td>
</tr>
</tbody>
</table>
</div>
<p>Now whenever I write new essay and push the source to the Git repo, the Codeship hook automatically build the middleman and push to the static hosting service. When the article is set to a future date, the build process won’t immediately build that post. For every hour, the installed web task invokes the middleman building process and it build the pre-written posts when the time comes.</p>
				
											<hr>
						<p>
						  Published on October 3, 2015. More articles like this:  	

						  <a href="/category/web-design/">Web Technologies</a>.						</p>
						
						<div>
							<p>Want productive tips and web technologies links like this in your inbox each week? Sign up for <a href='https://makzan.substack.com/archive'>weekly dispatch</a> each week. No spam ever. Just useful content:</p>
							<iframe width="100%" height="320" src="https://makzan.substack.com/embed" frameborder="0" scrolling="no"></iframe>
					    </div>
					
										
										
				</article>
			</section>
		






		<section>
			<footer class="clearfix">

				<p>I love to share know-how on web technologies.</p>
				
				<nav id="mainnav" class="nav-collapse"><ul id="menu-main-menu" class="menu"><li id="menu-item-890" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-home menu-item-890"><a href="/">Home</a></li>
<li id="menu-item-1143" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1143"><a href="/articles/">Articles</a></li>
<li id="menu-item-374" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-374"><a href="/html5-games-list/">Games</a></li>
<li id="menu-item-27" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-27"><a href="/about/">About</a></li>
<li id="menu-item-1223" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-1223"><a href="/now">/now</a></li>
</ul></nav>	

			</footer>
		</section>
		</div><!-- wrap -->
 
			<div style="display:none">
	</div>
<script type='text/javascript' src='https://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=201948'></script>
<script type='text/javascript' src='https://secure.gravatar.com/js/gprofiles.js?ver=2019Novaa'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/jetpack/modules/wpgroho.js?ver=5.3'></script>
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=5.3'></script>
<script type='text/javascript' src='https://stats.wp.com/e-201948.js' async='async' defer='defer'></script>
<script type='text/javascript'>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:7.3.2',blog:'103413133',post:'194',tz:'8',srv:'makzan.blog'} ]);
	_stq.push([ 'clickTrackerInit', '103413133', '194' ]);
</script>
		



	</body>
</html>